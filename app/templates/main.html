<!DOCTYPE html>
<html>
<head>
    <title> RaspCopy </title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="/static/css/bootstrap-responsive.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/Chart.Core.js"></script>
    <script src="/static/js/Chart.Doughnut.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/static/img/PiIcon.ico" rel="icon" />
    <link href="/static/img/PiIcon.png" rel="shortcut icon" />
    <link rel="apple-touch-icon" href="/static/img/PiIconiOS.png"/>
    <link rel="stylesheet" href="/static/font-awesome-4.2.0/css/font-awesome.min.css">
    <style>
        td input[type="checkbox"] {
            margin: 0 auto;
            width: 100%;
        }

    </style>
</head>
<body>

  <div class="container-fluid">
   <div class="row">
     <div class="col-md-6">
        <h1><p class="text-center">RaspBerry</p></h1>
        <div class="table-responsive">
           <div id="source_file_table">

           </div>
       </div>
   </div>
   <div class="col-md-6">
    <h1><p class="text-center">Key</p></h1>
    <div class="table-responsive">
        <div id="destination_file_table">

        </div>
    </div>
</div>

</div>

<div class="col-md-12" >
  <div class="collapse" id="StatusPane">
      <div class="progress">
        <div class="progress-bar" role="progressbar" id="fileCopyProgress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
            0%
        </div>
    </div>
    <div class="progress">
        <div class="progress-bar" role="progressbar" id="overallCopyProgress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
            0%
        </div>
    </div>
</div>
</div>
<div class="col-md-12">
   <div class="btn-group" role="group">
    <button id=copy class="btn btn-success btn-large">Copy<i class="glyphicon glyphicon-chevron-right"></i></button>
</div>

</div>
</div>
</body>

{% include 'error_dialog.html' %}
{% include 'confirm_dialog.html' %}
{% include 'file_system_info.html' %}

</html>

<script>

    var gCurrentSide = 'source'
    var gStatusRefreshPeriodMs = 1000;

    $( document ).ready( function(){
        set_folder('source','home')
        set_folder('destination','home')
        $('#StatusPane').collapse({'toggle': false});
    });

    function refresh(side){

        if(side)
        {
            set_folder('source','');
        }
        else
        {
            set_folder('source','')
            set_folder('destination','')
        }
    }

    function set_folder(side,folder){

        $("#"+side+"_file_table").load('/open_folder',{side: side, folder: folder});
    }

    function select_file(side,file_name){

        $("#selected_size_id_"+side).load('/select_file',{side: side, file_name: file_name});
    }

    function deselect_file(side,file_name){

        $("#selected_size_id_"+side).load('/deselect_file',{side: side, file_name: file_name});

    }

    function clear_selected_files(side){

     $("#selected_size_id_"+side).load('/clear',{side: side});

 }

 function mount_file_system(side){

    $.post("/mount",
    {
        side: side
    },function(data){
        if(data.error){
            $("#errorDialogMessage").html("<p>"+data.message+"</p>");
            $("#errorDialogMessageDetails").text(data.error_details);

            $('#errorDialog').modal('show');
        }
        else {

            setTimeout(function() { indicate_action_in_progress('mount',side,true)}, gStatusRefreshPeriodMs);
        }
    });

}

function moveup(side){

  $.post("/moveup",
  {
    side: side
},function(data,status){
    refresh(side);
});
}

function movedown(side){

 $.post("/movedown",
 {
    side: side
},function(data,status){
    refresh(side);
});

}

function unmount_file_system(side){

    $.post("/unmount",
    {
        side: side
    },function(data){
        if(data.error){
            $("#errorDialogMessage").html("<p>"+data.message+"</p>");
            $("#errorDialogMessageDetails").text(data.error_details);

            $('#errorDialog').modal('show');
        }
        else {

            setTimeout(function() { indicate_action_in_progress('unmount',side,true)}, gStatusRefreshPeriodMs);
        }
    });
}


$("#copy").click( function(){

  $.post("/copy",{},function(data ){

    if(data.error){
        $("#errorDialogMessage").html("<p>"+data.message+"</p>");
        $("#errorDialogMessageDetails").text(data.error_details);

        $('#errorDialog').modal('show');
    }
    else {

        setTimeout('update_copy_status()', gStatusRefreshPeriodMs);
    }

});

});

function update_copy_status()
{

    $.getJSON("/copy_status",function(result){

        if(result.error){

            $('#StatusPane').collapse('hide');

            set_folder('destination','')

            $("#errorDialogMessage").html("<p>"+result.message+"</p>");
            $("#errorDialogMessageDetails").text(result.error_details);

            $('#errorDialog').modal('show');



        }
        else if(!result.complete){

            $('#StatusPane').collapse('show');

            $('#fileCopyProgress').css('width', result.file_percent+'%').attr('aria-valuenow', result.file_percent);

            $('#fileCopyProgress').text(result.copy_status + ' : ' + result.file_percent.toString()+'%');

            $('#overallCopyProgress').css('width', result.overall_percent+'%').attr('aria-valuenow', result.overall_percent);

            $('#overallCopyProgress').text('Overall Status: ' + result.overall_percent.toString()+'%');

            setTimeout('update_copy_status()', gStatusRefreshPeriodMs);
        }
        else {

            $('#StatusPane').collapse('hide');

            set_folder('destination','')
        }
    })

}

function createDirectory(side){

    $.post("/create_dir",{'name': $('#directory_name').val(),'side': side},function(data ){

        if(data.error){
            $("#errorDialogMessage").html("<p>"+data.message+"</p>");
            $("#errorDialogMessageDetails").text(data.error_details);

            $('#errorDialog').modal('show');
        }
        else {

            setTimeout(function() { indicate_action_in_progress('create_dir',side,true)}, gStatusRefreshPeriodMs);
        }

    });
}

function deleteCurrentFolder(side)
{
   $.post("/deleteFolder",{side: side},function(data ){

    if(data.error){
        $("#errorDialogMessage").html("<p>"+data.message+"</p>");
        $("#errorDialogMessageDetails").text(data.error_details);

        $('#errorDialog').modal('show');
    }
    else {

        set_folder(side,'..')

        setTimeout(function() { indicate_action_in_progress('delete_folder',side,true)}, gStatusRefreshPeriodMs);
    }

});
}

function deleteSelectedFiles(side){

    $.post("/deleteFiles",{side: side},function(data ){

        if(data.error){
            $("#errorDialogMessage").html("<p>"+data.message+"</p>");
            $("#errorDialogMessageDetails").text(data.error_details);

            $('#errorDialog').modal('show');
        }
        else {

            setTimeout(function() { indicate_action_in_progress('delete_files',side,true,function(){clear_selected_files(side);})}, gStatusRefreshPeriodMs);
        }

    });
}

function animate(turnOn, baseID, side)
{
    spinnerID = baseID + '_spin_' + side;
    iconID = baseID + '_icon_' + side;

    if(turnOn)
    {
        $('#'+spinnerID).show();
        $('#'+iconID).hide();
    }
    else
    {
        $('#'+spinnerID).hide();
        $('#'+iconID).show();
    }
}


var background_job_status_str = ''
function indicate_action_in_progress(background_job_name,side,start,finish_function)
{


  $.getJSON("/job_status",{job_name: background_job_name}, function(result){

    if(result.error){

        $("#errorDialogMessage").html("<p>"+result.message+"</p>");
        $("#errorDialogMessageDetails").text(result.error_details);

        $('#errorDialog').modal('show');

    }
    else if(!result.complete){


        ///if(start){
            animate(true, background_job_name, side);
       // }

        if(result.status != background_job_status_str)
        {
            set_folder(side,'');
        }
        background_job_status_str = result.status

        setTimeout(function() { indicate_action_in_progress(background_job_name,side,false,finish_function)}, gStatusRefreshPeriodMs);
    }
    else {

       animate(false, background_job_name, side);
       set_folder(side,'')


       if(finish_function)
       {
        finish_function();
    }
}
})
}

</script>